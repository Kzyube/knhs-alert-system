<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KNHS DRRM Alert System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --school-blue: #003366;
            --danger-red: #dc3545;
            --safe-green: #28a745;
            --light-bg: #f0f2f5;
            --white: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--light-bg);
            color: #333;
            display: flex; flex-direction: column; height: 100vh;
        }

        header {
            background-color: var(--school-blue); color: var(--white);
            padding: 15px; display: flex; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1001;
        }
        .logo-area { font-size: 24px; margin-right: 15px; }
        .school-info h1 { margin: 0; font-size: 16px; font-weight: 700; }
        .school-info p { margin: 0; font-size: 12px; opacity: 0.9; }

        #main-container {
            flex: 1; padding: 15px;
            overflow-y: auto; position: relative;
        }

        .status-card {
            background: var(--white); border-radius: 12px;
            padding: 25px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        .safe-state { border-top: 5px solid var(--safe-green); }
        .safe-state .status-icon { color: var(--safe-green); font-size: 50px; }
        
        .danger-state { 
            border-top: 5px solid var(--danger-red); display: none; 
            animation: shake 0.5s;
        }
        .danger-state .status-icon { color: var(--danger-red); font-size: 50px; animation: pulse-red 1s infinite; }
        .danger-state h2 { color: var(--danger-red); text-transform: uppercase; font-weight: 800; margin: 10px 0; }

        #emergency-interface {
            display: none; height: 100%; flex-direction: column; gap: 15px;
        }

        #visual-guide-card {
            background: var(--white); padding: 10px; border-radius: 12px;
            text-align: center; flex-shrink: 0;
        }
        #guide-img {
            width: 100%; height: 150px; object-fit: cover; border-radius: 8px;
        }

        #map-container {
            flex: 1; border-radius: 12px; overflow: hidden;
            border: 2px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,0.2);
            position: relative; min-height: 300px; 
        }
        #map { width: 100%; height: 100%; }

        .distance-badge {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); background: white;
            padding: 8px 15px; border-radius: 20px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000;
            font-size: 14px; color: var(--school-blue);
        }

        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 51, 102, 0.95); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 350px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .login-input {
            width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #ddd;
            border-radius: 8px; font-family: 'Poppins'; font-size: 16px; box-sizing: border-box;
        }
        .btn-login {
            background: var(--school-blue); color: white; width: 100%; padding: 12px;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        .safety-panel {
            background: white; border-radius: 12px; padding: 20px; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #ffc107;
        }
        .btn-mark-safe {
            background: var(--safe-green); color: white; border: none; width: 100%;
            padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s; display: flex; justify-content: center; gap: 10px;
        }
        .btn-mark-safe:active { transform: scale(0.98); }
        .note-area {
            width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 8px;
            padding: 10px; margin-top: 15px; font-family: 'Poppins'; box-sizing: border-box;
        }
        .btn-send-note {
            background: var(--school-blue); color: white; border: none; padding: 8px 20px;
            border-radius: 20px; font-size: 12px; margin-top: 10px; float: right; cursor: pointer;
        }

        #setup-overlay {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 2000;
        }
        .btn-activate {
            background-color: var(--school-blue); color: white; border: none;
            padding: 12px 25px; border-radius: 30px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,51,102,0.3); cursor: pointer;
            display: flex; align-items: center; gap: 10px;
        }

        footer { text-align: center; padding: 10px; font-size: 11px; color: #888; background: #fff; }

        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(51, 136, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(51, 136, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(51, 136, 255, 0); }
        }

        /* CUSTOM MARKER STYLE */
        .dest-marker { text-align: center; color: white; text-shadow: 0 0 3px black; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>
    <div id="login-modal">
        <div class="login-box">
            <i class="fas fa-user-graduate" style="font-size: 40px; color: var(--school-blue); margin-bottom: 10px;"></i>
            <h2>Student Check-In</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 20px;">Enter your Student ID to connect.</p>
            <input type="text" id="student-id-input" class="login-input" placeholder="LRN / Student ID">
            <button class="btn-login" onclick="loginUser()">ENTER SYSTEM</button>
        </div>
    </div>

    <header>
        <div class="logo-area"><i class="fas fa-graduation-cap"></i></div>
        <div class="school-info">
            <h1>KABACAN NATIONAL HIGH SCHOOL</h1>
            <p>DRRM Safety & Alert Network</p>
        </div>
    </header>

    <div id="main-container">
        <div id="safe-card" class="status-card safe-state">
            <div class="status-icon"><i class="fas fa-shield-alt"></i></div>
            <h2>SYSTEM ACTIVE</h2>
            <p>Status: <strong>Normal</strong></p>
            <p style="font-size: 12px; color: #666;">Locating you... (Drag Blue Dot to Adjust)</p>
            
            <div id="map-container" style="margin-top:20px; height:300px;">
                <div id="map"></div>
                <div id="dist-display" class="distance-badge" style="display:none;">0m to Safety</div>
            </div>
        </div>

        <div class="safety-panel">
            <h3 style="margin-top: 0; font-size: 14px; color: #555;">MY STATUS</h3>
            <button id="btn-safe" class="btn-mark-safe" onclick="markAsSafe()">
                <i class="fas fa-check-circle"></i> I AM SAFE
            </button>
            <div style="margin-top: 15px;">
                <label style="font-size: 12px; font-weight: 600;">Report to Admin:</label>
                <textarea id="student-note" class="note-area" placeholder="E.g., Injured leg, stuck in Room 102..."></textarea>
                <button class="btn-send-note" onclick="sendNote()">SEND UPDATE</button>
                <div style="clear: both;"></div>
            </div>
        </div>

        <div id="danger-card" class="status-card danger-state">
            <div class="status-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 id="alert-type-text">EMERGENCY</h2>
            <p id="alert-message-text">Proceed to evacuation areas.</p>
        </div>

        <div id="emergency-interface">
            <div id="visual-guide-card">
                <div style="font-weight: 600; font-size: 12px; margin-bottom: 5px; color: var(--school-blue);">
                    <i class="fas fa-eye"></i> DESTINATION VIEW
                </div>
                <img id="guide-img" src="" alt="Guide" onerror="this.src='https://placehold.co/600x400?text=No+Image+Available'">
            </div>
        </div>
    </div>

    <div id="setup-overlay">
        <button id="setup-btn" class="btn-activate" onclick="activateGPS()">
            <i class="fas fa-satellite-dish"></i> ENABLE GPS TRACKING
        </button>
    </div>

    <footer>&copy; 2026 KNHS ICT Department</footer>
    <audio id="siren" loop src="https://www.soundjay.com/mechanical/sounds/smoke-detector-1.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const socket = io();
        const safeCard = document.getElementById('safe-card');
        const dangerCard = document.getElementById('danger-card');
        const emergencyInterface = document.getElementById('emergency-interface');
        const alertTitle = document.getElementById('alert-type-text');
        const alertMsg = document.getElementById('alert-message-text');
        const guideImg = document.getElementById('guide-img');
        const setupBtn = document.getElementById('setup-btn');
        const siren = document.getElementById('siren');
        const distDisplay = document.getElementById('dist-display');

        let map, userMarker, destMarker, routeLine;
        let isSystemActive = false;

        // --- REAL COORDINATES FOR KABACAN NHS ---
        const KNHS_LAT = 7.100263749131452;
        const KNHS_LNG = 124.82403728169497;
        
        const LOCATIONS = {
            OPEN_SPACE: [7.100595643301358, 124.82393316416237],
            COURT_1:    [7.100166532874036, 124.82429162308269],
            OVAL:       [7.100203, 124.824066] 
        };

        // --- 1. AUTO-START MAP ---
        window.onload = function() {
            initMap();
            checkLogin();
        };

        function initMap() {
            map = L.map('map').setView([KNHS_LAT, KNHS_LNG], 18);
            
            // Satellite View
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(map);
            
            // Street Labels
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);

            // Add School Marker
            const destIcon = L.divIcon({
                className: 'dest-marker',
                html: `<div style="font-size:30px; color:#28a745; text-shadow:0 0 5px black;"><i class="fas fa-map-marker-alt"></i></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            destMarker = L.marker([KNHS_LAT, KNHS_LNG], {icon: destIcon}).addTo(map)
                .bindPopup("<b>Kabacan National HS</b><br>Safety Point").openPopup();
        }

        function activateGPS() {
            if(isSystemActive) return;
            setupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CONNECTING...';

            if (navigator.geolocation) {
                // FORCE HIGH ACCURACY FOR PHONES
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };

                navigator.geolocation.watchPosition(
                    (pos) => {
                        isSystemActive = true;
                        setupBtn.style.display = 'none';
                        updateUserLocation(pos.coords.latitude, pos.coords.longitude);
                    },
                    (err) => { 
                        console.log(err);
                        alert("Please Enable GPS on your device settings."); 
                        setupBtn.innerHTML = "RETRY GPS"; 
                    },
                    options
                );
            } else { alert("GPS not supported"); }
        }

        function updateUserLocation(lat, lng) {
            const userLatLng = L.latLng(lat, lng);
            
            if (!userMarker) {
                const userIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background-color:#007bff; width:16px; height:16px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px white; animation: pulse-blue 1.5s infinite;'></div>",
                    iconSize: [20, 20], iconAnchor: [10, 10]
                });
                
                // MAKE MARKER DRAGGABLE FOR TESTING
                userMarker = L.marker(userLatLng, {
                    icon: userIcon,
                    draggable: true 
                }).addTo(map);

                // If user drags the marker, recalculate path
                userMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    if(destMarker) drawDirectPath(position, destMarker.getLatLng());
                });

            } else {
                // Only auto-move if not dragging (prevents jitter)
                userMarker.setLatLng(userLatLng);
            }

            // Draw line if destination is known
            if(destMarker) {
                drawDirectPath(userLatLng, destMarker.getLatLng());
            }
        }

        function drawDirectPath(start, end) {
            if(routeLine) map.removeLayer(routeLine);
            
            // This is the PATH LOGIC (Green Dashed Line)
            routeLine = L.polyline([start, end], {
                color: '#28a745', weight: 6, opacity: 0.9, dashArray: '10, 10'
            }).addTo(map);

            const dist = start.distanceTo(end).toFixed(0);
            distDisplay.innerText = `${dist} meters to Safety`;
            distDisplay.style.display = 'block';
        }

        // --- LOGIN & DATA ---
        let studentID = localStorage.getItem('knhs_student_id');

        function checkLogin() {
            if (studentID) {
                document.getElementById('login-modal').style.display = 'none';
                socket.emit('register-student', studentID);
            }
        }

        function loginUser() {
            const input = document.getElementById('student-id-input').value.trim();
            if (input.length > 0) {
                studentID = input;
                localStorage.setItem('knhs_student_id', studentID);
                checkLogin();
            } else { alert("Enter ID"); }
        }

        // --- SOCKET ALERTS ---
        socket.on('receive-alert', (data) => {
            if (data.type === 'SAFE') triggerSafeMode();
            else triggerDangerMode(data);
        });

        function triggerSafeMode() {
            safeCard.style.display = 'block';
            dangerCard.style.display = 'none';
            emergencyInterface.style.display = 'none';
            siren.pause(); siren.currentTime = 0;
            // Move map back to safe card
            document.getElementById('safe-card').appendChild(document.getElementById('map-container'));
            if(map) map.invalidateSize();
        }

        function triggerDangerMode(data) {
            safeCard.style.display = 'none';
            dangerCard.style.display = 'block';
            emergencyInterface.style.display = 'flex';
            
            alertTitle.innerText = `${data.type} DETECTED`;
            alertMsg.innerText = data.message;
            siren.play().catch(e=>{});

            // Move map to emergency interface
            document.getElementById('emergency-interface').appendChild(document.getElementById('map-container'));
            if(map) map.invalidateSize();

            // Smart Destination Logic
            let destCoords = LOCATIONS.COURT_1; 
            if (data.type === 'EARTHQUAKE' || data.type === 'FIRE') destCoords = LOCATIONS.OPEN_SPACE;
            
            const newDest = L.latLng(destCoords[0], destCoords[1]);
            destMarker.setLatLng(newDest);
            
            if(userMarker) {
                drawDirectPath(userMarker.getLatLng(), newDest);
                map.fitBounds(L.latLngBounds([userMarker.getLatLng(), newDest]), {padding:[50,50]});
            } else {
                map.setView(newDest, 18);
            }
        }

        function markAsSafe() {
            if (!studentID) return alert("Login First");
            const btn = document.getElementById('btn-safe');
            btn.innerHTML = '<i class="fas fa-check-double"></i> SENT!';
            btn.style.backgroundColor = '#28a745';
            
            const loc = userMarker ? userMarker.getLatLng() : {lat: null, lng: null};
            socket.emit('student-status', { id: studentID, status: 'SAFE', lat: loc.lat, lng: loc.lng });
        }

        function sendNote() {
            const note = document.getElementById('student-note').value;
            if(note) {
                socket.emit('student-note', { id: studentID, message: note });
                document.getElementById('student-note').value = '';
                alert("Sent!");
            }
        }
    </script>
</body>
</html>